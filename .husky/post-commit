#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

last_commit_message=$(git log -1 --pretty=%B)

if [[ "$last_commit_message" != *"Bump version. v"* ]]; 
then
    LAST_VERSION=$(node -p -e "require('./package.json').version")
    
    # Incrementing versionCode in Android's build.gradle
    sed -i.bak -E 's/versionCode ([0-9]+)/echo "versionCode $((\1+1))"/ge' android/app/build.gradle
    # Remove the backup file created by sed
    rm android/app/build.gradle.bak
    
    # Incrementing CFBundleVersion in iOS's Info.plist
    new_version=$(($(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" ios/AirbnbClone/Info.plist) + 1))
    /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $new_version" ios/AirbnbClone/Info.plist
    
    git add android/app/build.gradle ios/AirbnbClone/Info.plist ios/AirbnbCloneTests/Info.plist
    git commit --amend --no-edit
else
    echo "Skipping automated version bump to avoid infinite loop."
fi
